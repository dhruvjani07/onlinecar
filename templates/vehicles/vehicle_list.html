{% extends 'vehicles/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Browse Cars - AutoMarket{% endblock %}

{% block content %}
<div class="container my-5">
    <h2 class="fw-bold mb-4">Browse Available Cars</h2>
    
    <!-- Search and Filter Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="{% url 'vehicle_list' %}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        {{ form.query }}
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Company</label>
                        <select class="form-select" id="search_company" name="company">
                            <option value="">All Companies</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Model</label>
                        <select class="form-select" id="search_model" name="model">
                            <option value="">All Models</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Category</label>
                        {{ form.category }}
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Min Price (€)</label>
                        {{ form.min_price }}
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Max Price (€)</label>
                        {{ form.max_price }}
                    </div>
                    
                    <div class="col-md-6 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="bi bi-search"></i> Search
                        </button>
                        <a href="{% url 'vehicle_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Clear
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Results Count -->
    <div class="mb-3">
        <p class="text-muted">Found {{ vehicles.paginator.count }} vehicle(s)</p>
    </div>
    
    <!-- Vehicle Grid -->
    <div class="row">
        {% for vehicle in vehicles %}
        <div class="col-md-4 mb-4">
            <div class="card h-100 shadow-sm">
                {% if vehicle.image1 %}
                    <img src="{{ vehicle.image1.url }}" class="card-img-top" alt="{{ vehicle.title }}" style="height: 200px; object-fit: cover;">
                {% else %}
                    <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 200px;">
                        <i class="bi bi-car-front" style="font-size: 3rem;"></i>
                    </div>
                {% endif %}
                
                <div class="card-body">
                    <h5 class="card-title">{{ vehicle.title }}</h5>
                    <p class="text-muted small mb-2">{{ vehicle.company }} {{ vehicle.model }} • {{ vehicle.year }}</p>
                    <h4 class="text-primary fw-bold">€{{ vehicle.price|floatformat:0 }}</h4>
                    
                    <div class="d-flex justify-content-between text-muted small mb-3">
                        <span><i class="bi bi-speedometer2"></i> {{ vehicle.mileage|floatformat:0 }} km</span>
                        <span><i class="bi bi-fuel-pump"></i> {{ vehicle.get_fuel_type_display }}</span>
                        <span><i class="bi bi-gear"></i> {{ vehicle.get_transmission_display }}</span>
                    </div>
                    
                    <a href="{% url 'vehicle_detail' vehicle.pk %}" class="btn btn-primary w-100">
                        <i class="bi bi-eye"></i> View Details
                    </a>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No vehicles found matching your criteria.
            </div>
        </div>
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if vehicles.has_other_pages %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if vehicles.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ vehicles.previous_page_number }}&{{ request.GET.urlencode }}">Previous</a>
            </li>
            {% endif %}
            
            {% for num in vehicles.paginator.page_range %}
            <li class="page-item {% if vehicles.number == num %}active{% endif %}">
                <a class="page-link" href="?page={{ num }}&{{ request.GET.urlencode }}">{{ num }}</a>
            </li>
            {% endfor %}
            
            {% if vehicles.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ vehicles.next_page_number }}&{{ request.GET.urlencode }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- JavaScript for Car Search Dropdowns -->
<script>
// Car data (same as in form)
const carData = {
  "BMW": ["1 Series", "2 Series", "3 Series", "4 Series", "5 Series", "6 Series", "7 Series", "8 Series", "M2", "M3", "M4", "M5", "M8", "X1", "X2", "X3", "X4", "X5", "X6", "X7", "Z4", "i3", "i4", "i8", "iX"],
  "Mercedes-Benz": ["A-Class", "B-Class", "C-Class", "E-Class", "S-Class", "CLA", "CLS", "GLA", "GLB", "GLC", "GLE", "GLS", "G-Class", "AMG GT", "EQC", "EQS"],
  "Audi": ["A1", "A3", "A4", "A5", "A6", "A7", "A8", "Q2", "Q3", "Q4 e-tron", "Q5", "Q7", "Q8", "TT", "R8", "e-tron GT"],
  "Toyota": ["Corolla", "Camry", "RAV4", "Highlander", "Land Cruiser", "Prius", "Yaris", "Avalon", "Supra", "4Runner", "Tacoma", "Tundra", "Sienna", "C-HR", "Fortuner", "Innova"],
  "Honda": ["Civic", "Accord", "CR-V", "HR-V", "Pilot", "Odyssey", "Fit", "Ridgeline", "Passport", "Insight", "City", "Amaze"],
  "Ford": ["Fiesta", "Focus", "Fusion", "Mustang", "Escape", "Explorer", "Expedition", "Edge", "Bronco", "F-150", "Ranger", "Maverick", "EcoSport"],
  "Volkswagen": ["Golf", "Polo", "Passat", "Tiguan", "Touareg", "Arteon", "T-Roc", "T-Cross", "ID.3", "ID.4", "ID.5", "Vento"],
  "Nissan": ["Micra", "Sentra", "Altima", "Maxima", "Juke", "Qashqai", "X-Trail", "Pathfinder", "Murano", "Armada", "GT-R", "Z", "Leaf", "Kicks", "Magnite"],
  "Hyundai": ["i10", "i20", "i30", "Elantra", "Sonata", "Accent", "Kona", "Tucson", "Santa Fe", "Palisade", "Ioniq 5", "Ioniq 6", "Creta", "Venue", "Verna"],
  "Kia": ["Picanto", "Rio", "Ceed", "Forte", "K5", "Stinger", "Seltos", "Sportage", "Sorento", "Telluride", "EV6", "Niro", "Sonet", "Carens"],
  "Mazda": ["Mazda2", "Mazda3", "Mazda6", "CX-3", "CX-30", "CX-5", "CX-9", "CX-60", "MX-5 Miata"],
  "Chevrolet": ["Spark", "Sonic", "Cruze", "Malibu", "Camaro", "Corvette", "Trax", "Equinox", "Traverse", "Tahoe", "Suburban", "Silverado"],
  "Tesla": ["Model 3", "Model S", "Model X", "Model Y", "Cybertruck", "Roadster"],
  "Porsche": ["911", "718 Boxster", "718 Cayman", "Panamera", "Cayenne", "Macan", "Taycan"],
  "Jaguar": ["XE", "XF", "XJ", "F-Type", "E-Pace", "F-Pace", "I-Pace"],
  "Land Rover": ["Defender", "Discovery", "Discovery Sport", "Range Rover", "Range Rover Sport", "Range Rover Evoque", "Range Rover Velar"],
  "Volvo": ["S60", "S90", "V60", "V90", "XC40", "XC60", "XC90", "C40 Recharge"],
  "Subaru": ["Impreza", "Legacy", "Outback", "Forester", "Crosstrek", "Ascent", "WRX", "BRZ"],
  "Lexus": ["IS", "ES", "GS", "LS", "RC", "LC", "UX", "NX", "RX", "GX", "LX"],
  "Jeep": ["Renegade", "Compass", "Cherokee", "Grand Cherokee", "Wrangler", "Gladiator", "Wagoneer", "Grand Wagoneer"],
  "Tata": ["Nexon", "Harrier", "Safari", "Punch", "Altroz", "Tigor", "Tiago", "Nexon EV", "Tiago EV", "Hexa", "Aria", "Indica", "Indigo"],
  "Mahindra": ["XUV700", "XUV500", "XUV300", "Scorpio", "Scorpio-N", "Thar", "Bolero", "KUV100", "Marazzo", "TUV300", "e2o", "eVerito", "XUV400"]
};

// Populate search dropdowns on page load
document.addEventListener('DOMContentLoaded', function() {
    const companySelect = document.getElementById('search_company');
    const modelSelect = document.getElementById('search_model');
    
    // Add all companies to dropdown
    Object.keys(carData).sort().forEach(company => {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        companySelect.appendChild(option);
    });
    
    // When company changes, update models
    companySelect.addEventListener('change', function() {
        const selectedCompany = this.value;
        modelSelect.innerHTML = '<option value="">All Models</option>';
        
        if (selectedCompany && carData[selectedCompany]) {
            carData[selectedCompany].forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });
            modelSelect.disabled = false;
        } else {
            modelSelect.disabled = false;
        }
    });
    
    // Preserve selected values from URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const selectedCompany = urlParams.get('company');
    const selectedModel = urlParams.get('model');
    
    if (selectedCompany) {
        companySelect.value = selectedCompany;
        // Trigger change to populate models
        companySelect.dispatchEvent(new Event('change'));
        
        // Set model after a small delay to ensure models are populated
        setTimeout(() => {
            if (selectedModel) {
                modelSelect.value = selectedModel;
            }
        }, 100);
    }
});
</script>
{% endblock %}